<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Terra Comparisons — Minimal Swipe (NDVI / GPP / LST / AOD / Snow / Burned)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./Build/Cesium/Widgets/widgets.css">
  <style>
    html, body, #cesiumContainer { height:100%; width:100%; margin:0; background:#0b1120; overflow:hidden; }
    .ui {
      position:absolute; z-index:10000; left:10px; top:10px;
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
      padding:10px 12px; color:#fff; background:rgba(0,0,0,.55); border-radius:12px;
      font:13px system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Helvetica, Arial;
      box-shadow:0 14px 40px rgba(0,0,0,.45);
    }
    .ui select, .ui button, .ui input[type="range"] {
      background:#111827; color:#e5e7eb; border:1px solid #374151; border-radius:8px; padding:6px 10px; font-weight:600;
    }
    .ui button:hover, .ui select:hover { background:#1f2937; cursor:pointer; }
    .pill {
      position:absolute; right:10px; top:10px; z-index:10000;
      padding:8px 10px; color:#fff; background:rgba(0,0,0,.55); border-radius:10px; font:12px system-ui;
      box-shadow:0 10px 30px rgba(0,0,0,.4); min-width:190px;
    }
    .legend {
      position:absolute; right:10px; bottom:10px; z-index:10000;
      padding:8px 10px; color:#fff; background:rgba(0,0,0,.55); border-radius:10px; font:12px system-ui;
      box-shadow:0 10px 30px rgba(0,0,0,.4);
    }
    .splitwrap {
      position:absolute; left:10px; bottom:12px; z-index:10000;
      padding:8px 10px; color:#fff; background:rgba(0,0,0,.55); border-radius:10px; font:12px system-ui;
      box-shadow:0 10px 30px rgba(0,0,0,.4); display:flex; align-items:center; gap:8px;
    }
  </style>
</head>
<body>
  <div id="cesiumContainer" role="presentation"></div>

  <!-- Minimal controls -->
  <div class="ui" role="group" aria-label="Terra comparison controls">
    <label>Left
      <select id="leftSel">
        <option value="ndvi16">NDVI (16-day)</option>
        <option value="gpp8">GPP (8-day)</option>
        <option value="lst_day">LST Day (daily)</option>
        <option value="aod">Aerosol (daily)</option>
        <option value="snow">Snow Cover (daily)</option>
        <option value="burned">Burned Area (monthly)</option>
      </select>
    </label>
    <span style="opacity:.8">vs</span>
    <label>Right
      <select id="rightSel">
        <option value="aod">Aerosol (daily)</option>
        <option value="ndvi16">NDVI (16-day)</option>
        <option value="gpp8">GPP (8-day)</option>
        <option value="lst_day">LST Day (daily)</option>
        <option value="snow">Snow Cover (daily)</option>
        <option value="burned">Burned Area (monthly)</option>
      </select>
    </label>

    <button id="play">⏯︎</button>
    <select id="step">
      <option value="1">step: 1 day</option>
      <option value="8">step: 8 days</option>
      <option value="16" selected>step: 16 days</option>
      <option value="30">step: ~1 month</option>
    </select>

    <button id="prev">⟵</button>
    <button id="next">⟶</button>

    <span id="loading" style="opacity:.75"></span>
  </div>

  <div class="splitwrap">
    <span>Swipe</span>
    <input id="split" type="range" min="0" max="100" value="50" />
  </div>

  <div class="pill">
    <div><strong>Date</strong>: <span id="dspan">—</span></div>
    <div><strong>Left</strong>: <span id="ltitle">—</span></div>
    <div><strong>Right</strong>: <span id="rtitle">—</span></div>
  </div>

  <div class="legend" id="legend">
    <div style="font-weight:700; margin-bottom:6px">NDVI (16-day)</div>
    <div style="display:flex;align-items:center;gap:8px">
      <div style="width:160px;height:10px;background:linear-gradient(to right,#6e6e6e,#c9d66b,#4caf50,#006400)"></div>
      <div>low → high</div>
    </div>
    <div style="display:flex;justify-content:space-between;margin-top:4px;opacity:.9">
      <span>&lt;0.1 barren/snow</span><span>0.2–0.5 shrubs/grass</span><span>0.6–0.8 forests</span>
    </div>
  </div>

  <script src="./Build/Cesium/Cesium.js"></script>
  <script>
    // ---------- Viewer ----------
    const viewer = new Cesium.Viewer("cesiumContainer", {
      animation:false, timeline:false, baseLayerPicker:false, geocoder:false, sceneModePicker:true
    });
    viewer.scene.skyAtmosphere.show = false;
    viewer.scene.globe.baseColor = Cesium.Color.fromCssColorString("#0b1120");
    viewer.scene.globe.enableLighting = true;
    viewer.scene.requestRenderMode = false;

    const CA_RECT = Cesium.Rectangle.fromDegrees(-125.0, 32.0, -113.5, 43.0);
    viewer.camera.setView({ destination: CA_RECT });

    // --- Split support (works on old Cesium too) ---
    const Split = Cesium.ImagerySplitDirection || Cesium.SplitDirection || null;
    const HAS_LAYER_SPLIT = !!(Split && viewer.scene && 'imagerySplitPosition' in viewer.scene);

    function applySplitOrCrossfade(leftLayer, rightLayer, t01 /* 0..1 */) {
      if (!leftLayer || !rightLayer) return;
      if (HAS_LAYER_SPLIT && 'splitDirection' in leftLayer && 'splitDirection' in rightLayer) {
        leftLayer.splitDirection  = Split.LEFT;
        rightLayer.splitDirection = Split.RIGHT;
        viewer.scene.imagerySplitPosition = t01;
        leftLayer.alpha = rightLayer.alpha = 1.0;
      } else {
        // Fallback: crossfade (no swipe available in this Cesium build)
        leftLayer.splitDirection = rightLayer.splitDirection = undefined;
        leftLayer.alpha  = 1 - t01;
        rightLayer.alpha = t01;
      }
      viewer.scene.requestRender();
    }

    // ---------- Error silencer (quiet 400/404 tile spam) ----------
    function silenceErrors(provider){
      provider?.errorEvent.addEventListener((err) => {
        const msg = String(err?.message || err?.error || '');
        if (/(404|400|Bad\s*Request|NoSuchKey)/i.test(msg)) err.retry = false;
      });
    }

    // ---------- Layer catalog (Terra-only where possible) ----------
    const LAYERS = {
      ndvi16: { title:"NDVI (16-day)", id:"MODIS_Terra_L3_NDVI_16Day", maxLevel:7, cadence:"16d", fmt:"png" },
      gpp8:   { title:"GPP (8-day)",   id:"MODIS_Terra_L4_Gross_Primary_Productivity_8Day", maxLevel:7, cadence:"8d", fmt:"png" },
      lst_day:{ title:"LST Day (daily)", id:"MODIS_Terra_Land_Surface_Temp_Day", maxLevel:7, cadence:"day", fmt:"png" },
      aod:    { title:"Aerosol (daily)", id:"MODIS_Terra_Aerosol", maxLevel:7, cadence:"day", fmt:"png" },
      snow:   { title:"Snow Cover (daily)", id:"MODIS_Terra_NDSI_Snow_Cover", maxLevel:8, cadence:"day", fmt:"png" },
      burned: { title:"Burned Area (monthly)", id:"MODIS_Terra_Aqua_Burned_Area", maxLevel:6, cadence:"month", fmt:"png" }
    };

    // Context: ASTER hillshade under everything
    (function addHillshade(){
      const prov = new Cesium.UrlTemplateImageryProvider({
        url: "https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/ASTER_GDEM_Color_Shaded_Relief/default/2000-01-01/GoogleMapsCompatible_Level8/{z}/{y}/{x}.jpg",
        tilingScheme: new Cesium.WebMercatorTilingScheme(), maximumLevel:8, credit:"NASA EOSDIS GIBS"
      });
      silenceErrors(prov);
      const layer = viewer.imageryLayers.addImageryProvider(prov);
      layer.alpha = 0.9; layer.rectangle = CA_RECT;
    })();

    // ---------- Date helpers ----------
    const pad = n => (n<10 ? "0"+n : ""+n);
    function ymd(d){ return `${d.getUTCFullYear()}-${pad(d.getUTCMonth()+1)}-${pad(d.getUTCDate())}`; }
    function ym01(d){ return `${d.getUTCFullYear()}-${pad(d.getUTCMonth()+1)}-01`; }
    function snapN(d, N){
      const yearStart = Date.UTC(d.getUTCFullYear(),0,1);
      const dayOfYear = Math.floor((Date.UTC(d.getUTCFullYear(),d.getUTCMonth(),d.getUTCDate()) - yearStart)/86400000) + 1;
      const snapped = dayOfYear - ((dayOfYear-1) % N);
      const out = new Date(Date.UTC(d.getUTCFullYear(),0,1)); out.setUTCDate(snapped);
      return out;
    }
    function dateForKey(key, dateObj){
      const cad = LAYERS[key].cadence;
      if (cad === "16d") return ymd(snapN(dateObj,16));
      if (cad === "8d")  return ymd(snapN(dateObj,8));
      if (cad === "month") return ym01(dateObj);
      return ymd(dateObj); // daily
    }

    // ---------- Providers & layer replacement ----------
    function buildProvider(key, dateStr){
      const meta = LAYERS[key];
      const url = `https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/${meta.id}/default/{Time}/GoogleMapsCompatible_Level9/{z}/{y}/{x}.${meta.fmt}`;
      const prov = new Cesium.UrlTemplateImageryProvider({
        url, tilingScheme:new Cesium.WebMercatorTilingScheme(), maximumLevel: meta.maxLevel,
        credit:"NASA EOSDIS GIBS", customTags:{ Time: () => dateStr }
      });
      silenceErrors(prov);
      return prov;
    }

    let tileProgress = 0;
    viewer.scene.globe.tileLoadProgressEvent.addEventListener(n => {
      tileProgress = n; loading.textContent = n ? `loading tiles: ${n}` : "";
    });

    function waitUntilTilesSettled(baseline, timeoutMs = 9000) {
      return new Promise(resolve => {
        let stable = 0; const started = performance.now();
        function step() {
          stable = tileProgress <= baseline ? stable + 1 : 0;
          if (stable >= 2 || (performance.now() - started) > timeoutMs) resolve();
          else requestAnimationFrame(step);
        }
        requestAnimationFrame(step);
      });
    }

    async function replaceLayer(oldLayer, key, dateStr, alpha=1){
      const prov = buildProvider(key, dateStr);
      const baseline = tileProgress;
      const L = viewer.imageryLayers.addImageryProvider(prov);
      L.rectangle = CA_RECT;
      L.alpha = 0.0001;
      await waitUntilTilesSettled(baseline);
      // quick fade
      const t0 = performance.now();
      return new Promise(res=>{
        function step(t){
          const k = Math.min((t - t0)/300, 1);
          L.alpha = alpha * k;
          if (oldLayer) oldLayer.alpha = (1 - k) * (oldLayer.alpha ?? 1);
          viewer.scene.requestRender();
          if (k<1) requestAnimationFrame(step); else { if (oldLayer) viewer.imageryLayers.remove(oldLayer,true); res(L); }
        }
        requestAnimationFrame(step);
      });
    }

    // ---------- Animation state ----------
    const leftSel  = document.getElementById("leftSel");
    const rightSel = document.getElementById("rightSel");
    const playBtn  = document.getElementById("play");
    const stepSel  = document.getElementById("step");
    const prevBtn  = document.getElementById("prev");
    const nextBtn  = document.getElementById("next");
    const dspan    = document.getElementById("dspan");
    const ltitle   = document.getElementById("ltitle");
    const rtitle   = document.getElementById("rtitle");
    const splitInp = document.getElementById("split");
    const loading  = document.getElementById("loading");
    const legend   = document.getElementById("legend");

    const startDate = new Date(Date.UTC(2011,0,1));
    const endDate   = new Date(Date.UTC(2021,11,31));
    let current = new Date(Date.UTC(2020,7,15)); // Aug 15, 2020

    let leftLayer=null, rightLayer=null, timer=null;

    function updateLegend(){
      const showNDVI = (leftSel.value === "ndvi16") || (rightSel.value === "ndvi16");
      legend.style.display = showNDVI ? "block" : "none";
    }

    async function rebuild(){
      const Lkey = leftSel.value, Rkey = rightSel.value;
      const Ldate = dateForKey(Lkey, current);
      const Rdate = dateForKey(Rkey, current);

      dspan.textContent = ymd(current);
      ltitle.textContent = LAYERS[Lkey].title + ` (${Ldate})`;
      rtitle.textContent = LAYERS[Rkey].title + ` (${Rdate})`;
      updateLegend();

      // Replace both layers first...
      leftLayer  = await replaceLayer(leftLayer,  Lkey, Ldate, 1.0);
      rightLayer = await replaceLayer(rightLayer, Rkey, Rdate, 1.0);

      // ...then apply swipe or crossfade
      const t = Number(splitInp.value) / 100;
      applySplitOrCrossfade(leftLayer, rightLayer, t);
    }

    function stepDays(n){
      const t = new Date(current.getTime()); t.setUTCDate(t.getUTCDate() + n);
      if (t < startDate) current = new Date(startDate);
      else if (t > endDate) current = new Date(endDate);
      else current = t;
      rebuild();
    }

    // ---------- UI wiring ----------
    leftSel.onchange  = rebuild;
    rightSel.onchange = rebuild;

    playBtn.onclick = () => {
      if (timer){ clearInterval(timer); timer = null; playBtn.textContent = "⏯︎"; return; }
      const inc = parseInt(stepSel.value, 10) || 1;
      timer = setInterval(()=> {
        stepDays(inc);
        if (current >= endDate){ clearInterval(timer); timer = null; playBtn.textContent = "⏯︎"; }
      }, 600);
      playBtn.textContent = "⏸︎";
    };

    prevBtn.onclick = () => stepDays(-parseInt(stepSel.value,10));
    nextBtn.onclick = () => stepDays(+parseInt(stepSel.value,10));

    splitInp.oninput = () => applySplitOrCrossfade(leftLayer, rightLayer, Number(splitInp.value)/100);

    // ---------- Start ----------
    applySplitOrCrossfade(leftLayer, rightLayer, 0.5);
    rebuild();
  </script>
</body>
</html>
