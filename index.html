<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Terra (GIBS) + FIRMS — Token-free Cesium</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cesium@1.118/Build/Cesium/Widgets/widgets.css">
  <style>html,body,#map{width:100%;height:100%;margin:0;background:#000}</style>
</head>
<body>
<div id="map"></div>

<script src="https://cdn.jsdelivr.net/npm/cesium@1.118/Build/Cesium/Cesium.js"></script>
<script>
  // 1) Viewer with NO ion terrain
  const viewer = new Cesium.Viewer("map", {
    baseLayerPicker: false,
    timeline: false,
    animation: false,
    terrain: new Cesium.EllipsoidTerrain() // <-- no ion
  });

  // 2) Guaranteed basemap (so you see Earth right away)
  const osm = new Cesium.OpenStreetMapImageryProvider({ url: "https://a.tile.openstreetmap.org/" });
  viewer.imageryLayers.addImageryProvider(osm);

  // 3) Fly to California
  viewer.camera.flyTo({ destination: Cesium.Rectangle.fromDegrees(-125, 32, -113, 43), duration: 1.2 });

  // Helper
  function iso(jd){ return Cesium.JulianDate.toIso8601(jd).slice(0,10); }

  // 4) GIBS WMTS (EPSG:4326) — use the correct TileMatrixSet for the product
  const GIBS_WMTS_4326 = "https://gibs.earthdata.nasa.gov/wmts/epsg4326/best/wmts.cgi";

  // Terra True Color (250 m). TileMatrixSet is "250m" per GIBS docs.
  const terraTrueColor = new Cesium.WebMapTileServiceImageryProvider({
    url: GIBS_WMTS_4326,
    layer: "MODIS_Terra_CorrectedReflectance_TrueColor",
    style: "default",
    format: "image/jpeg",
    tileMatrixSetID: "250m",   // <-- IMPORTANT: correct matrix set for this layer
    times: Cesium.TimeIntervalCollection.fromIso8601({
      iso8601: "2020-08-20/2020-08-21/P1D",
      dataCallback: (iv) => ({ time: iso(iv.start) })
    })
  });
  viewer.imageryLayers.addImageryProvider(terraTrueColor);

  // NDVI 16-Day (Terra). Many sites expose it as "MODIS_Terra_L3_NDVI_16Day"; still 250m matrix.
  const terraNDVI = new Cesium.WebMapTileServiceImageryProvider({
    url: GIBS_WMTS_4326,
    layer: "MODIS_Terra_L3_NDVI_16Day",  // if this 404s, confirm exact ID in GIBS capabilities
    style: "default",
    format: "image/png",
    tileMatrixSetID: "250m",
    times: Cesium.TimeIntervalCollection.fromIso8601({
      iso8601: "2020-08-20/2020-08-21/P1D",
      dataCallback: (iv) => ({ time: iso(iv.start) })
    })
  });
  const ndviLayer = viewer.imageryLayers.addImageryProvider(terraNDVI);
  ndviLayer.alpha = 0.45;

  // 5) FIRMS WMS-Time — show a 7-day window so short events appear
  const FIRMS_WMS = "https://firms.modaps.eosdis.nasa.gov/mapserver/wms";
  const fires7d = new Cesium.WebMapServiceImageryProvider({
    url: FIRMS_WMS,
    layers: "Fires_All_MODIS", // see FIRMS WMS docs for layer names
    parameters: { transparent: "true", format: "image/png", styles: "" },
    times: Cesium.TimeIntervalCollection.fromIso8601({
      iso8601: "2020-08-20/2020-08-21/P1D",
      dataCallback: () => ({ TIME: "2020-08-15/2020-08-21" }) // 7-day range
    })
  });
  const fires = viewer.imageryLayers.addImageryProvider(fires7d);
  fires.alpha = 0.85;

  // Optional: hide stars
  viewer.scene.skyBox.show = false;
  viewer.scene.skyAtmosphere.show = true;
</script>
</body>
</html>
